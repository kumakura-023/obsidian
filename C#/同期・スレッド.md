---
created: 2025-11-11T15:21
updated: 2025-11-11T16:46
---
## ğŸ§  åŒæœŸãƒ»ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ»UIé–¢é€£ã®ç†è§£ã¾ã¨ã‚

### â‘  `await` ã®æœ¬è³ª

- `await` ã¯ **Taskï¼ˆéåŒæœŸå‡¦ç†ï¼‰ã®å®Œäº†ã‚’â€œå¾…ã¤â€æ§‹æ–‡**ã€‚  
    ã§ã‚‚ã€Œå¾…ã¤ã€ã¨ã„ã£ã¦ã‚‚**ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã›ãšã€ä¸€æ—¦æŠœã‘ã‚‹**ã€‚
    
- ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãŒã€Œå‰åŠã€ã€Œå¾ŒåŠã€ã«åˆ†ã‘ã€å®Œäº†ã—ãŸã¨ãã«**å¾ŒåŠï¼ˆç¶šãï¼‰ã‚’å†é–‹**ã€‚
    
- ã€Œç¶šãã€ã‚’ã©ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œã™ã‚‹ã‹ã¯**åŒæœŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆSynchronizationContextï¼‰** ãŒæ±ºã‚ã‚‹ã€‚â†’ç©ºã„ã¦ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ã«å‰²ã‚Šå½“ã¦ã¦ã„ãã€‚

```C#
// ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ãªã©UIã‚¹ãƒ¬ãƒƒãƒ‰ã§
private async void btnRun_Click(object sender, EventArgs e)
{
    lblStatus.Text = "å‰åŠï¼šé–‹å§‹";

    // ã“ã“ã§ä¸€æ—¦ã€ŒæŠœã‘ã‚‹ã€ã€‚ã‚¹ãƒ¬ãƒƒãƒ‰ã¯ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ã€‚
    var data = await DownloadStringAsync("https://example.com");

    // â† ã“ã“ã‹ã‚‰ãŒã€Œawait ã®ç¶šãã€
    lblStatus.Text = $"å¾ŒåŠï¼š{data.Length} chars";
}

// ç–‘ä¼¼I/Oï¼ˆæœ¬ç•ªãªã‚‰ HttpClient ãªã©ï¼‰
private async Task<string> DownloadStringAsync(string url)
{
    await Task.Delay(500); // I/Oå¾…ã¡ã®ä»£ã‚ã‚Š
    return "hello world";
}
```

### â‘¡ `ConfigureAwait(false)` ã®æ„å‘³

- ã€Œ**awaitã®ç¶šãã¯UIã‚¹ãƒ¬ãƒƒãƒ‰ã«æˆ»ã•ãªãã¦ã„ã„**ã€ã¨ã„ã†æŒ‡å®šã€‚
	
- awaitã®ç¶šãâ†’awaitã®æ¬¡ã®è¡Œä»¥é™ã‹ã‚‰ãã®é–¢æ•°ã®çµ‚ã‚ã‚Šã¾ã§
    
- UIã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ç„¡è¦–ã—ã¦ã€ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ—ãƒ¼ãƒ«ä¸Šã®ã‚¹ãƒ¬ãƒƒãƒ‰ã§å†é–‹ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã€‚
    
- æ–°ã—ã„ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’â€œä½œã‚‹â€ã‚ã‘ã§ã¯ãªãã€**ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ—ãƒ¼ãƒ«å†…ã®ã©ã‚Œã‹**ã§å†é–‹ã™ã‚‹ã ã‘ã€‚
    
- ã ã‹ã‚‰ **ã€Œå¸¸ã«åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã§å‹•ãã€ã§ã¯ãªãã€ã€ŒUIã‚¹ãƒ¬ãƒƒãƒ‰ã«ã¯æˆ»ã‚‰ãªã„ã€** ãŒæ­£ç¢ºã€‚

```C#
private async void btnRun2_Click(object sender, EventArgs e)
{

    lblStatus.Text = "éUIã§ç¶šã";
    await Task.Delay(500).ConfigureAwait(false); // â˜…UIã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«æˆ»ã•ãªã„

    // ã“ã“ã¯éUIã‚¹ãƒ¬ãƒƒãƒ‰ã®å¯èƒ½æ€§ãŒé«˜ã„ã€‚UIã‚’ç›´æ¥è§¦ã‚‰ãªã„ï¼
    var text = "ç¶šãã¯éUI";
    
    // UIæ›´æ–°ã¯ãƒãƒ¼ã‚·ãƒ£ãƒªãƒ³ã‚°
    BeginInvoke((Action)(() => lblStatus.Text = text));
}
```
### â‘¢ ã‚¤ãƒ™ãƒ³ãƒˆã¨æ˜ç¤ºåŒæœŸï¼ˆãƒ—ãƒ«ã¨ãƒ—ãƒƒã‚·ãƒ¥ï¼‰

- ã‚¤ãƒ™ãƒ³ãƒˆ (`PortsChanged`) ã¯ã€Œ**ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å´ã‹ã‚‰é€šçŸ¥ï¼ˆãƒ—ãƒƒã‚·ãƒ¥ï¼‰**ã€ã€‚
	
- ã‚¤ãƒ™ãƒ³ãƒˆï¼å‰²ã‚Šè¾¼ã¿å‡¦ç†
    
- æ˜ç¤ºåŒæœŸ (`RefreshPortsAsync`) ã¯ã€Œ**è‡ªåˆ†ã§å–ã‚Šã«è¡Œãï¼ˆãƒ—ãƒ«ï¼‰**ã€ã€‚æ™®é€šã«å‘¼ã‚“ã§ã‚‹ã ã‘ã€‚
    
- èµ·å‹•ç›´å¾Œã‚„æ‰‹å‹•å†ã‚¹ã‚­ãƒ£ãƒ³ãªã©**ç¢ºå®Ÿã«æœ€æ–°åŒ–ã—ãŸã„ã¨ãã¯æ˜ç¤ºåŒæœŸãŒâ€œæ­£â€**ã€‚
    
- ãµã ã‚“ã®USBæŠœãå·®ã—ãªã©ã¯**ã‚¤ãƒ™ãƒ³ãƒˆã§è‡ªå‹•è¿½å¾“ï¼ˆä¾¿åˆ©ï¼‰**ã€‚  
    â†’ ã€Œã‚¤ãƒ™ãƒ³ãƒˆé ¼ã¿ï¼‹æ˜ç¤ºåŒæœŸã®ä½µç”¨ã€ãŒãƒ™ã‚¹ãƒˆã€‚ï¼ˆèµ·å‹•ç›´å¾Œãªã©å‹•ä½œãŒä¸å®‰å®šãªæ™‚ã«æ˜ç¤ºåŒæœŸï¼‰

```C#
// ã‚«ã‚¿ãƒ­ã‚°ã£ã½ã„æœ€å°å®Ÿè£…ï¼ˆå·®åˆ†æ¤œçŸ¥ã§ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«ï¼‰
public interface IPortCatalog
{
    event EventHandler<IReadOnlyList<string>> PortsChanged;
    Task RefreshAsync(CancellationToken ct);
    IReadOnlyList<string> GetCurrentPorts();
}

public class DummyCatalog : IPortCatalog
{
    public event EventHandler<IReadOnlyList<string>> PortsChanged;
    private List<string> _ports = new();

    public Task RefreshAsync(CancellationToken ct)
    {
        var latest = new List<string> { "COM3", DateTime.Now.Second % 2 == 0 ? "COM5" : "COM4" };
        if (!_ports.SequenceEqual(latest))
        {
            _ports = latest;
            PortsChanged?.Invoke(this, _ports); // â˜…ãƒ—ãƒƒã‚·ãƒ¥
        }
        return Task.CompletedTask;
    }

    public IReadOnlyList<string> GetCurrentPorts() => _ports;
}

// ViewModel/ãƒ•ã‚©ãƒ¼ãƒ å´ï¼šãƒ—ãƒƒã‚·ãƒ¥ + ãƒ—ãƒ«ã®ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰
private IPortCatalog _catalog = new DummyCatalog();

private void Form1_Load(object sender, EventArgs e)
{
    _catalog.PortsChanged += (s, ports) =>
        BeginInvoke((Action)(() => UpdatePorts(ports))); // â˜…ãƒ—ãƒƒã‚·ãƒ¥ã§è¿½å¾“

    _ = RefreshPortsAsync(); // â˜…èµ·å‹•ç›´å¾Œã¯â€œæ˜ç¤ºåŒæœŸï¼ˆãƒ—ãƒ«ï¼‰â€ã§æ­£ã‚’ä½œã‚‹
}

private async Task RefreshPortsAsync()
{
    await _catalog.RefreshAsync(CancellationToken.None).ConfigureAwait(false);
    var snapshot = _catalog.GetCurrentPorts();
    BeginInvoke((Action)(() => UpdatePorts(snapshot)));
}

private void UpdatePorts(IReadOnlyList<string> ports)
{
    comboPorts.DataSource = ports.ToList();
}
```

### â‘£ UIã‚¹ãƒ¬ãƒƒãƒ‰ã¨ãƒãƒ¼ã‚·ãƒ£ãƒªãƒ³ã‚°

- **UIã‚¹ãƒ¬ãƒƒãƒ‰**ã¯ã€Œç”»é¢æç”»ãƒ»ã‚¯ãƒªãƒƒã‚¯ãƒ»ã‚­ãƒ¼å…¥åŠ›ã€ã‚’å‡¦ç†ã™ã‚‹â€œ1æœ¬ã ã‘ã®å°‚ç”¨ã‚¹ãƒ¬ãƒƒãƒ‰â€ã€‚  
    WinFormsã§ã¯ `Application.Run()` ã§å§‹ã¾ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ãŒã“ã‚Œã€‚
    
- **ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ãƒ¬ãƒƒãƒ‰**ã¯ `Task.Run` ã‚„ `await ConfigureAwait(false)` ãªã©ã§å‹•ãåˆ¥ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã€‚
    
- UIã‚¹ãƒ¬ãƒƒãƒ‰ä»¥å¤–ã‹ã‚‰UIã‚’è§¦ã‚‹ã¨ä¾‹å¤–ã«ãªã‚‹ã€‚  
    â†’ `BeginInvoke()` ã‚„ `IProgress<T>` ã§**UIã‚¹ãƒ¬ãƒƒãƒ‰ã«å‡¦ç†ã‚’â€œæŠ•ã’ã‚‹ï¼ˆãƒãƒ¼ã‚·ãƒ£ãƒªãƒ³ã‚°ï¼‰â€**ã€‚
    
- `BeginInvoke()` ã¯ã€ŒUIã‚¹ãƒ¬ãƒƒãƒ‰ã®ã‚­ãƒ¥ãƒ¼ã«éåŒæœŸã§å‡¦ç†ã‚’ç™»éŒ²ã—ã¦å¸°ã‚‹ã€ã€‚  
    ã‚¹ãƒ¬ãƒƒãƒ‰å®‰å…¨ã¨ã¯ã€Œè¤‡æ•°ã‚¹ãƒ¬ãƒƒãƒ‰ã‹ã‚‰åŒæ™‚ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã‚‚å£Šã‚Œãªã„ã€ã“ã¨ã€‚WinFormsã®UIã¯éã‚¹ãƒ¬ãƒƒãƒ‰å®‰å…¨ãªã®ã§ã€å¿…ãšãƒãƒ¼ã‚·ãƒ£ãƒªãƒ³ã‚°ãŒå¿…è¦ã€‚

```C#
// ã©ã“ã‹ã‚‰å‘¼ã°ã‚Œã¦ã‚‚å®‰å…¨ã«UIã‚’è§¦ã‚Œã‚‹ãƒ©ãƒƒãƒ‘
private void SetSafe(Label label, string text)
{
    if (label.InvokeRequired)
    {
        label.BeginInvoke((Action)(() => label.Text = text)); // â˜…éåŒæœŸã§ä¾é ¼
        return;
    }
    label.Text = text; // â˜…UIã‚¹ãƒ¬ãƒƒãƒ‰
}
```

### â‘¤ `IProgress<T>` ã§ã®é€²æ—å ±å‘Š

- `Progress<T>` ã¯ä½œã‚‰ã‚ŒãŸã‚¹ãƒ¬ãƒƒãƒ‰ã® **åŒæœŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ** ã‚’è‡ªå‹•ã§æ•ã¾ãˆã‚‹ã€‚
    
- ã ã‹ã‚‰UIã‚¹ãƒ¬ãƒƒãƒ‰ä¸Šã§ä½œã‚Œã°ã€`Report()` ã‚’åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã‹ã‚‰å‘¼ã‚“ã§ã‚‚**UIã‚¹ãƒ¬ãƒƒãƒ‰ã§å‡¦ç†ã•ã‚Œã‚‹**ã€‚
    
- `Progress<T>` ã¯ã€ŒUIã‚¹ãƒ¬ãƒƒãƒ‰ã«æˆ»ã—ã¦ãƒãƒ³ãƒ‰ãƒ©ã‚’å®Ÿè¡Œã—ã¦ãã‚Œã‚‹ `BeginInvoke` ã®ãƒ©ãƒƒãƒ‘ã€ã€‚

```C#
private async void btnProgress_Click(object sender, EventArgs e)
{
    // UIã‚¹ãƒ¬ãƒƒãƒ‰ä¸Šã§ Progress ã‚’ä½œã‚‹ï¼ˆUIã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ•ã¾ãˆã‚‹ï¼‰
    var progA = new Progress<int>(v => progressBarA.Value = v); // â˜…è‡ªå‹•ã§UIã¸
    var progB = new Progress<int>(v => progressBarB.Value = v);

    var cts = new CancellationTokenSource();

    var taskA = ProcessAsync("A", progA, cts.Token);
    var taskB = ProcessAsync("B", progB, cts.Token);

    await Task.WhenAll(taskA, taskB); // UIã¯ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œãªã„
}

// è£å´ï¼ˆUIã‚’è§¦ã‚‰ãªã„ï¼ï¼‰
private async Task ProcessAsync(string name, IProgress<int> progress, CancellationToken ct)
{
    for (int i = 0; i <= 100; i++)
    {
        ct.ThrowIfCancellationRequested();
        await Task.Delay(20, ct);      // æ“¬ä¼¼ä»•äº‹
        if (i % 2 == 0) progress.Report(i); // â˜…é–“å¼•ãã‚‚å¯
    }
}
```

### â‘¥ ä¸¦è¡Œã‚¿ã‚¹ã‚¯ã¨UIã®é–¢ä¿‚ï¼ˆä¾‹ï¼šå‡¦ç†Aãƒ»å‡¦ç†Bãƒ»å‡¦ç†Cï¼‰

- å„å‡¦ç†ã¯ `await Task.Run(...)` ã§**ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ãƒ¬ãƒƒãƒ‰**ã«æµã™ã€‚
    
- é€²æ—å ±å‘Šã¯ `IProgress<T>` ã‹ `BeginInvoke` çµŒç”±ã§UIã«å®‰å…¨ã«åæ˜ ã€‚
    
- UIã‚¹ãƒ¬ãƒƒãƒ‰ã¯1æœ¬ãªã®ã§ã€è¤‡æ•°ã®é€²æ—å ±å‘ŠãŒæ¥ã¦ã‚‚**ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ¥ãƒ¼ã«ä¸¦ã¶**ã‹ã‚‰è¡çªã—ãªã„ã€‚
    
- UIã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ãŸã‚ã«ã€é‡ã„å‡¦ç†ã‚’UIã‚¹ãƒ¬ãƒƒãƒ‰ã§å‹•ã‹ã•ãªã„ã®ãŒé‰„å‰‡ã€‚

```C#
private async void btnABC_Click(object sender, EventArgs e)
{
    // é€²æ—ã¯IProgressã§UIã¸ï¼ˆBeginInvokeã„ã‚‰ãšï¼‰
    var pA = new Progress<int>(v => progressBarA.Value = v);
    var pB = new Progress<int>(v => progressBarB.Value = v);
    var pC = new Progress<int>(v => progressBarC.Value = v);

    using var cts = new CancellationTokenSource();

    // CPUãƒã‚¦ãƒ³ãƒ‰ãªã‚‰ Task.Runã€ä¸­ã§é€²æ—ã¯ Report
    var a = Task.Run(() => CpuHeavy("A", pA, cts.Token), cts.Token);
    var b = Task.Run(() => CpuHeavy("B", pB, cts.Token), cts.Token);

    // I/Oãƒã‚¦ãƒ³ãƒ‰ãªã‚‰ãã®ã¾ã¾await
    var c = IoLikeAsync("C", pC, cts.Token);

    // UIã¯ã“ã®é–“ã‚‚è‡ªç”±ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§ãã‚‹ï¼‰ã€‚çµ‚äº†å¾…ã¡ã ã‘await
    await Task.WhenAll(a, c, b);
}

private void CpuHeavy(string name, IProgress<int> progress, CancellationToken ct)
{
    for (int i = 0; i <= 100; i++)
    {
        ct.ThrowIfCancellationRequested();
        Thread.SpinWait(2_000_000); // æ“¬ä¼¼CPUè² è·
        if (i % 5 == 0) progress.Report(i);
    }
}

private async Task IoLikeAsync(string name, IProgress<int> progress, CancellationToken ct)
{
    for (int i = 0; i <= 100; i += 2)
    {
        ct.ThrowIfCancellationRequested();
        await Task.Delay(15, ct); // æ“¬ä¼¼I/Oå¾…ã¡
        progress.Report(i);
    }
}

```